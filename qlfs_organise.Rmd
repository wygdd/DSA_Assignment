---
title: "Maths and Statistics Foundations Project"
author: "Group N"
date: "06/10/2017"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#1. Introduction

Discrimination has long been a controversial topic. Forms of discrimination can range greatly but over the last few decades, one notable form of discrimination has been the phenomenon of an income gap that has existed in society (Blinder, 1973). A widely discussed form of this discrepancy in income is gender. The European Commission defines gender pay gap as “the difference between men“s and women“s pay, based on the average difference in gross hourly earnings of all employees“ (European Commission, 2017). In recent years especially, addressing the gender-related pay gap has been a policy matter of many countries namely those belonging to the EU (European Union, 2014). 

According to the United Nations (2017), there are aims to alleviate the issue of gender discrimination to ensure gender equality. The European Commission (2017) does state that gender discrimination is prohibited under European law. However, the Office for National Statistics (2017) states that female full-time employees in the UK earn on average 9.4 percent less than male full-time employees in 2016. This raises the question if gender pay discrimination currently exists in the UK, and or if there are other drivers affecting the differences in salary levels.

Consequently, this report aims to identify if pay discrimination currently exists in the United Kingdom. To examine this, we will use data from the Office of National Statistics *Quarterly Labour Force Survey* for the period of January to March 2017 (ONS, 2017). We will consider factors which may affect the pay gap such as differences in where and how people in the UK tend to work/[namely nature (e.g. ethnicity) and nurture factors (occupation, region of work).  Following investigation of the variables and linear regressions, we hope to make inferences that would aid policy creation that aims to minimise the pay gap.


#2. Theory 
note: What do you expect to find?

Our null hypothesis is that all the predictors will not have a significant effect on salary. The alternative hypothesis is that the predictors do have a significant effect on salary.

We are interested in investigating whether this apparent income gap is a result of actual gender discrimination, which would be in accordance with our resources, or whether this phenomenon arises as a result of other variables' influences. We will thus investigate it in a linear regression model with relevant variables. 

In that aspect, we want to determine other possible causes of the income gap and whether working in different industry sectors or having different educational qualifications can affect salary when included in a linear regression model with salary as the independent variable.

(OR Our theory is that we believe, in line with our resources, that gender discrimination is still present in today's society. This will mean that in theory, we will expect that gender will have an effect on salary.)

#3. Methods
```{r load data and packages, echo=FALSE, message=FALSE}
library(dplyr)
library(haven)
library(ggplot2)
library(lmtest)
library(knitr)
library(stargazer)
library(gridExtra)
alldata <- read_dta("lfsp_jm17_eul.dta")
```


## 3.1 Data Description
```{r clean dataset, echo = FALSE}
#Created smaller manageable dataset from larger one which included variables we pre-selceted to explore + filtered data to remove observations where individuals did not answer or ...


selected <- alldata %>% select(AGE,SEX,INDE07M,HIQUL15D,MPNR02,SC10MMJ,BANDG,
                               MARSTA,RELIG11,ETHGBEUL,REGWKR)

colnames(selected) <- c("Age","Sex","Industry","Education",
                        "NumEmployee","Occupation","Salary",
                        "Marital","Religion","Ethnicity","workRegion")
#Salary
selected <- selected %>% filter(Salary!=1 & Salary!=2 & Salary!=3 
                                & Salary!=-8 & Salary!=-9)
#Age
#Sex
#Industry
selected <- selected %>% filter(Industry!=-8)
#Education
selected <- selected %>% filter(Education!=-8 & Education !=-9 & Education !=7)
#NumEmployee
selected <- selected %>% filter(NumEmployee!=-8 & NumEmployee !=-9)
#Occupation
selected <- selected %>% filter(Occupation!=-8 & Occupation!=-9)
#Marital
selected <- selected %>% filter(Marital!=-9)
#Religion
selected <- selected %>% filter(Religion!=-8)
#Ethnicity 
selected <- selected %>% filter(Ethnicity!=-8 & Ethnicity!=-9)
#workRegion
selected <- selected %>% filter(workRegion!=-8 & workRegion!=-9 & workRegion!=2)

# Create dataset qlfs to combine groups, the processed dataset qlfs contains numeric data 
qlfs <- as.data.frame(selected)

#Converted salary from interval to continuous data in order to perform linear regression
# weekly salaries are multiplied by 52 and monthly salaries are multiplied by 12. The salary data is thus in a range of amounts of earnings. In order to implement a linear regression model, we therefore calculated the mean of each range.

#BANDG
value_vec <- c('1.1','1.10','1.11','1.12','1.13','1.14','1.15','1.16','1.17',
               '1.18','1.19','1.2','1.20','1.21','1.22','1.23','1.24','1.25',
               '1.26','1.27','1.28','1.29','1.3','1.30','1.31','1.32','1.33',
               '1.34','1.4','1.5','1.6','1.7','1.8','1.9',
               '2.1','2.10','2.11','2.12','2.13','2.14','2.15','2.16','2.17',
               '2.18','2.19','2.2','2.20','2.21','2.22','2.23','2.24','2.25',
               '2.26','2.27','2.28','2.29','2.3','2.30','2.31','2.32','2.33',
               '2.34','2.4','2.5','2.6','2.7','2.8','2.9',
               "3.10","3.11","3.12","3.13","3.14","3.15","3.16","3.17","3.18",
               "3.19","3.20","3.21","3.22","3.23","3.24","3.25","3.26","3.27",
               "3.28","3.29","3.30","3.31","3.32","3.3","3.4","3.5","3.6",
               "3.7","3.8","3.9","3.2","3.34")
#-- Annually
a1  <- 0 
a2  <- seq(4249.5,4749.5,500)
a3  <- seq(5499.5,12499.5,1000)
a4  <- 249.5
a5  <- seq(13499.5,19499.5,1000)
a6  <-seq(21499.5,27499.5,3000)
a7  <- 749.5
a8  <- seq(30499.5,39499.5,3000)
a9  <- 41000
a10 <- seq(1249.5,3749.5,500)
annual <- c(a1,a2,a3,a4,a5,a6,a7,a8,a9,a10) 

#-- Monthly 
m1  <- 0 
m2  <- seq(424.5, 674.5, 50)
m3  <- seq(749.5, 1049.5, 100)
m4  <- 24.5
m5  <- seq(1149.5, 1949.5, 100)
m6  <- 2099.5
m7  <- 74.5
m8  <- 2349.5
m9  <- seq(2749.5, 3749.5, 500)
m10 <- 4000
m11 <- seq(124.5, 374.5, 50)
month_values <- c(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11)
months_annual <- month_values*12

#-- Weekly
w1 <- seq(84.5,104.5,10)
w2 <- 117
w3 <- seq(137,487,25)
w4 <- seq(524.5,674.5,50)
w5 <- seq(14.5,74.5,10) # for 3.3 to 3.9
w6 <- 5 # for 3.2
w7 <- 750 # for 3.34 weekly 750 or more
week_values <- c(w1,w2,w3,w4,w5,w6,w7)
week_annual <- week_values * 52

#-- Combine annually, monthly and weekly
salay_all <-c(annual,months_annual,week_annual)
salary_dict <- data.frame(key=value_vec,value=salay_all)
salary_dict$key <- as.character(salary_dict$key)

#-- Assign mean salary to qlfs$salary according to salary_dict
for (i in 1:nrow(qlfs)){
  qlfs$Salary[i] <- salary_dict$value[salary_dict$key==qlfs$Salary[i]]
}
#--BANDG of type 'character', change it to numeric
qlfs$Salary <- as.numeric(qlfs$Salary)

#Age
#Continuous numbers, no need for combination

#Sex
#Two groups, male and female, no need for combination

#Industry
qlfs$Industry <- ifelse( qlfs$Industry  == 1 
                        |qlfs$Industry == 2 
                        |qlfs$Industry == 3 
                        |qlfs$Industry == 4 
                        |qlfs$Industry == 6 
                        |qlfs$Industry == 9, 4, qlfs$Industry)
qlfs$Industry <- ifelse( qlfs$Industry  == 5, 1, qlfs$Industry)
qlfs$Industry <- ifelse( qlfs$Industry  == 7, 2, qlfs$Industry)
qlfs$Industry <- ifelse( qlfs$Industry  == 8, 3, qlfs$Industry)


#Education
# NumEmployee
qlfs$NumEmployee <- ifelse(qlfs$NumEmployee  == 1
                      |qlfs$NumEmployee == 2
                      |qlfs$NumEmployee == 3
                      |qlfs$NumEmployee == 4
                      |qlfs$NumEmployee == 5, 1, qlfs$NumEmployee)
qlfs$NumEmployee <- ifelse(qlfs$NumEmployee  == 6
                      |qlfs$NumEmployee == 7
                      |qlfs$NumEmployee == 8, 2, qlfs$NumEmployee)
qlfs$NumEmployee <- ifelse(qlfs$NumEmployee  == 9, 3, qlfs$NumEmployee)


#Occupation
# Marital
qlfs$Marital <- ifelse(!qlfs$Marital ==1 & 
                      !qlfs$Marital ==2, 3 , qlfs$Marital)
#Religion
qlfs$Religion <- ifelse(qlfs$Religion == 1, 1 ,2)

#Ethnicity
qlfs$Ethnicity <- ifelse(  qlfs$Ethnicity == 1 
                          |qlfs$Ethnicity== 2 
                          |qlfs$Ethnicity== 3, 1, qlfs$Ethnicity)
qlfs$Ethnicity <- ifelse(  qlfs$Ethnicity == 5 
                         |qlfs$Ethnicity == 6
                         |qlfs$Ethnicity == 7
                         |qlfs$Ethnicity == 8
                         |qlfs$Ethnicity == 9,  2, qlfs$Ethnicity)
qlfs$Ethnicity <- ifelse( qlfs$Ethnicity  == 10, 3, qlfs$Ethnicity)
qlfs$Ethnicity <- ifelse( qlfs$Ethnicity  == 4
                         |qlfs$Ethnicity == 11, 4, qlfs$Ethnicity)

#workRegion
qlfs$workRegion <- ifelse(qlfs$workRegion  == 20
                      |qlfs$workRegion == 21, 1, qlfs$workRegion)

qlfs$workRegion <- ifelse(qlfs$workRegion  == 1,  2, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 16
                      |qlfs$workRegion == 17
                      |qlfs$workRegion == 18, 3, qlfs$workRegion)

qlfs$workRegion <- ifelse(qlfs$workRegion  == 3
                      |qlfs$workRegion == 4
                      |qlfs$workRegion == 5,  4, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 6,  5, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 14
                      |qlfs$workRegion == 15, 6, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 19, 8, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 8
                      |qlfs$workRegion == 9
                      |qlfs$workRegion == 11 , 9, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 13, 10, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 12, 11, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 23, 12, qlfs$workRegion)
qlfs$workRegion <- ifelse(qlfs$workRegion  == 22, 13, qlfs$workRegion)

# Create dataset facQlfs, which change all the categorical variable of qlfs to factor with labels, in order for further linear regression.
facQlfs <- as.data.frame(qlfs)

#Age
#Sex
facQlfs$Sex <- factor( facQlfs$Sex,
                        levels=c(1,2),
                        labels = c('Male','Female'))
#Industry
facQlfs$Industry <- factor( facQlfs$Industry,
                            levels = c(1,2,3,4),
                            labels = c('Distribution, hotels, restaurants',
                                       'Banking, Finance',
                                       'Public admin, education, health',
                                       'Other'))
#Education
facQlfs$Education <- factor( facQlfs$Education, 
                             levels = c(1:6), 
                             labels = c('Degree',
                                        'Higher Education',
                                        'A Level',
                                        'GCSE A*-C',
                                        'Other',
                                        'No'))
#NumEmployee
facQlfs$NumEmployee <- factor(facQlfs$NumEmployee,
                         levels=c(1,2,3),
                         c('Under 50',
                           'Under 500',
                           'Over 500'))
#Occupation
facQlfs$Occupation <- factor(facQlfs$Occupation,
                          levels=c(1:9),
                          c('Managers, Directors, Senior Officials',
                            'Professional',
                            'Associate Professional, Technical',
                            'Administrative, Secretarial',
                            'Skilled Trades',
                            'Caring, Leisure, Other Service',
                            'Sales, Customer Service',
                            'Process, Plant, Machine Operatives',
                            'Elementary'))
# MARSTA
facQlfs$Marital <- factor( facQlfs$Marital, 
                           levels=c(1,2,3),
                           labels = c('Single','Married','Other'))
#RELIG11
facQlfs$Religion <- factor(facQlfs$Religion, 
                           levels=c(1,2),
                           labels = c('No','Yes'))
#ETHGBEUL
facQlfs$Ethnicity <-factor( facQlfs$Ethnicity, 
                            levels = c(1,2,3,4),
                            c('White','Asian','Black','Other')) 
#REGWKR
facQlfs$workRegion <- factor(facQlfs$workRegion,
                         levels = c(1:13),
                         c('Scotland',
                           'North East',
                           'North West',
                           'Yorkshire and the Humber',
                           'East Midlands',
                           'West Midlands',
                           'East of England',
                           'Wales',
                           'London',
                           'South West',
                           'South East',
                           'Outside UK',
                           'Northern Ireland'))

```

The dataset initially consisted of 88,528 observations of 739 variables. In order to examine the relationship between salary and gender and explore the possibility of gender discrimination in the UK, we have selected variables which also may impact the pay gap. Our final dataset contains 570 observations of 7 variables. These are outlined below.

|Variable                |Description                                       |
|:-----------------------|:-------------------------------------------------|
|`Salary`                |Salary of respondent (249.5 - 48000.0); N.b. adjusted for inflation|
|`Age`                   |Age of respondent (0-99)|
|`Sex`                   |Gender of respondent|
|`Occupation`            |Major occupation group of respondent|
|`Industry`              |Industry sector in main job|
|`Education`             |Highest qualification level|
|`NumEmployee`           |Number of employees at workplace|
|`Religion`              |Religion GB level|
|`MaritalStatus`         |Marital status|
|`Ethnicity`             |Ethnicity of respondent in GB|
|`Region of workplace`   |Region of place of work|

```{r summary}
summary(facQlfs)
```

```{r summary tables, echo=FALSE,results='asis', eval=FALSE}
# Industry
industry <- facQlfs %>% select(Industry) %>% group_by(Industry)%>% summarise(count=n())
kable(industry,col.names =c('Industry Type','#Individuals'),caption = 'Industry summary')

# Education
edu <- facQlfs %>% select(Education) %>% group_by(Education) %>% summarise(count=n())
kable(edu,col.names =c('Education Type','#Individuals'),caption='Education summary')

#NumEmployee
num_employee <-facQlfs %>% select(NumEmployee) %>% group_by(NumEmployee) %>% summarise(count=n())
kable(num_employee,col.names =c('Number of Employees', '#Individuals'),caption='Number of Employees Summary')

#Occupation
occupation <- facQlfs %>% select(Occupation) %>% group_by(Occupation) %>% summarise(count=n())
kable(occupation,col.names = c('Occupation type','#Individuals'),caption='Occupation Summary')

#Marital
marital <- facQlfs %>% select(Marital) %>% group_by(Marital) %>% summarise(count=n())
kable(marital,col.names=c('Marital status','#Individuals'),caption='Marital Status Summary')


#Religion
religion <- facQlfs %>% select(Religion) %>% group_by(Religion) %>% 
summarise(count=n())
kable(religion,col.names = c('Religion Type','#Individuals'),caption = 'Religion Summary')


#Ethnicity
ethnicity <- facQlfs %>% select(Ethnicity) %>% group_by(Ethnicity) %>% summarise(count=n())
kable(ethnicity,col.names = c('Ethnicity Type','#Individuals'),caption = 'Ethnicity Summary')

#WorkRegion
workregion <- facQlfs %>% select(Ethnicity) %>% group_by(Ethnicity) %>% summarise(count=n())
kable(ethnicity,col.names = c('Regions of Workplace','#Individuals'),caption=' Work regions Summary')
```


## 3.2 Strength and limitations








#4. Analysis
## 4.1 Descriptive statistics
### 4.1.1 Univariate descriptive of variables
#### Sex
```{r plots Sex,out.width="70%", fig.align="center",tidy=TRUE,tidy.opts=list(width.cutoff=60),echo = FALSE}


# Sex
box <- ggplot(facQlfs, aes(x=Sex,y=Salary,col=Sex))+ geom_boxplot()+ labs(title='Annually Salary distribution of Gender',x='Sex',y='Salary')+ theme(plot.title = element_text(hjust = 0.5))

man <- c(415, 532, 686, 773, 764, 757, 749, 656, 621)
woman <- c(366, 492, 573, 613, 568, 557, 529, 518, 405)
ages <- c("21-25", "26-30", "31-35", "36-40", "41-45", "46-50", "51-55", "56-60", "60-65")
dtmw <- data.frame(ages, man, woman)

week <- ggplot(dtmw) +geom_line(aes(x= ages, y=man,col='male'),group=1)+geom_point(aes(x= ages, y=man,col='male'))+ geom_line(aes(x= ages, y=woman,col='female'),group=2) + geom_point(aes(x= ages, y=woman,col='female'))+ylim(0,800)+ scale_color_discrete(name='Sex')+labs(title='Mean gross weekly pays in main job',x='Age',y='Salary')+theme(plot.title=element_text(hjust=0.5))

grid.arrange(box,week,ncol=2)
```

```{r table sex mean sd., echo=FALSE}
sextable<- facQlfs %>% select(Sex,Salary) %>% group_by(Sex) %>% summarise(Mean=mean(Salary),'Standard Deviation'=sd(Salary))
kable(sextable,align='l')
```

#### Industry
```{r plots Industry,out.width="70%", fig.align="center",tidy=TRUE,tidy.opts=list(width.cutoff=60),echo = FALSE}
# Industry
ggplot(facQlfs, aes(x=Industry,y=Salary,col=Industry))+ geom_boxplot()+ labs(title='Annually Salary distribution of Industry',x='Industry',y='Salary')+ theme(plot.title = element_text(hjust = 0.5), axis.text = element_text(angle= 45, hjust = 0.9))

```

```{r table industry mean sd, echo=FALSE}
industrytable <- facQlfs %>% select(Industry,Salary) %>% group_by(Industry) %>% summarise(Mean=mean(Salary),'Standard Deviation'=sd(Salary))
kable(industrytable,align='l')

```


#### Highest Education Level
```{r Highest Educational Level,out.width="70%", fig.align="center",tidy=TRUE,tidy.opts=list(width.cutoff=60),echo = FALSE}
# Education
ggplot(facQlfs, aes(x=Education,y=Salary,col=Education))+ geom_boxplot()+ labs(title='Annually Salary distribution of Highest Education Qualification',x='Highest Education Qualification',y='Salary')+ theme(plot.title = element_text(hjust = 0.5), axis.text = element_text(angle= 45, hjust = 0.9))
```


```{r}
eductable<- facQlfs %>% select(Education,Salary) %>% group_by(Education) %>% summarise(Mean=mean(Salary),'Standard Deviation'=sd(Salary))
kable(eductable,digits = 0, align=c('l','c','r'), caption = 'Salary Mean and Standard Deviation by Education')
```

#### Employee Numbers in workplace
```{r Employee Numbers in workplace,out.width="70%", fig.align="center",tidy=TRUE,tidy.opts=list(width.cutoff=60),echo = FALSE}
# NumEmployee
ggplot(facQlfs, aes(x=NumEmployee,y=Salary,col=NumEmployee))+geom_boxplot()+labs(title='Salary distribution of Employee numbers in workplace',x='Employee Numbers',y='Salary')+theme(plot.title = element_text(hjust = 0.5))


```

```{r}
numemploytable<- facQlfs %>% select(NumEmployee,Salary) %>% group_by(NumEmployee) %>% summarise(Mean=mean(Salary),'Standard Deviation'=sd(Salary))
kable(numemploytable,digits = 0, align=c('l','l','r'), caption = 'Salary Mean and Standard Deviation by # of Employees')
```

#### Occupations
```{r Occupations,out.width="70%", fig.align="center",tidy=TRUE,tidy.opts=list(width.cutoff=60),echo = FALSE}
# Occupation
ggplot(facQlfs, aes(x=Occupation,y=Salary,col=Occupation))+geom_boxplot()+labs(title='Salary distribution of Occupations',x='Occupations',y='Salary')+theme(plot.title = element_text(hjust = 0.5),axis.text = element_text(angle= 45, hjust = 0.9))


```


```{r}
occuptable<- facQlfs %>% select(Occupation,Salary) %>% group_by(Occupation) %>% summarise(Mean=mean(Salary),'Standard Deviation'=sd(Salary))
kable(occuptable,digits = 0, align='l', caption = 'Salary Mean and Standard Deviation by Occupation')
```

#### Religion
#### Ethnicity
#### Region of Workplace


### 4.1.2 Bivariate descriptive 
occupation industry
occupation education



## 4.2  Correlation analyses
occupation industry
occupation education
```{r,echo = FALSE}
cor.test(qlfs$Education,qlfs$Occupation)
cor.test(qlfs$Industry,qlfs$Occupation)
```

## 4.3  Hypothesis tests
#### 4.3.1 T-tests
```{r,echo = FALSE}
caring <-  facQlfs %>% select(Salary,Occupation) %>% filter(Occupation=="Caring, Leisure, Other Service")
sales <-  facQlfs %>% select(Salary,Occupation) %>% filter(Occupation=="Sales, Customer Service")
elem <- facQlfs %>% select(Salary,Occupation) %>% filter(Occupation=="Elementary")
t.test(caring$Salary,sales$Salary)
t.test(caring$Salary,elem$Salary)
t.test(sales$Salary,elem$Salary)

pairwise.t.test(facQlfs$Salary,facQlfs$Education)
pairwise.t.test(facQlfs$Salary,facQlfs$Sex)
pairwise.t.test(facQlfs$Salary,facQlfs$Industry)
pairwise.t.test(facQlfs$Salary,facQlfs$NumEmployee)
pairwise.t.test(facQlfs$Salary,facQlfs$Occupation)
```


#### 4.3.2 Chi-square tests 
```{r,echo = FALSE}
chisq.test(table(facQlfs$Industry,facQlfs$Occupation))
chisq.test(table(facQlfs$Education,facQlfs$Occupation))

```


## 4.4  Linear regression
```{r linear regression 1, echo=FALSE}
# All variables included
facQlfs.lm1 <- lm(Salary ~Education + Sex + 
                          Industry  + NumEmployee + 
                          Occupation +Marital + Religion +Ethnicity +workRegion,data=facQlfs )
summary(facQlfs.lm1)


# Drop less significant variables
facQlfs.lm2 <- lm(Salary ~ Education + Sex + 
                          Industry  + NumEmployee + 
                          Occupation,  data=facQlfs)
summary(facQlfs.lm2)
```

```{r print test table}
stargazer(list(facQlfs.lm1, facQlfs.lm2), digits = 2)

```

Null hypothesis for anova is that the mean(average value of the dependent variable) is the same for all groups 



```{r,echo = FALSE}
ggplot(facQlfs.lm2,aes(y=facQlfs.lm1$residuals,x=facQlfs.lm2$fitted))+geom_point()

qqnorm(facQlfs.lm2$residuals) 
qqline(facQlfs.lm2$residuals)


bptest(Salary ~ Education + Sex + 
                          Industry  + NumEmployee + 
                          Occupation,  data=facQlfs)

```



#5. Discussion
## 5.1 What results did you find
## 5.2 Why is it interesting
## 5.3 What would be the next steps



#6. References



# Notes:
parallel plots
message table for results
anova analysis
t-test tables
mean table for each boxplot 
whether include age in linear regression